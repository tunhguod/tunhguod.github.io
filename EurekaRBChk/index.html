<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>例のアレ</title>
  <style>
    table {
      border-collapse: collapse;
      margin-top: 1em;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .highlight-green {
      background-color: #a7f3d0;
    }
    .highlight-yellow {
      background-color: #fde68a;
    }
    button {
      margin: 0 2px;
    }
    .row-label {
      font-weight: bold;
      background-color: #f0f0f0;
    }
    .counter-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2px;
    }
    .counter-container input {
      width: 40px;
      text-align: right;
    }
  </style>
</head>
<body>
  <button onclick="resetAllCounters()">すべてクリア</button>
  <table id="data-table">
    <thead>
      <tr>
        <th>ptn/stg</th>
        <th>設定1</th>
        <th>設定2</th>
        <th>設定3</th>
        <th>設定4</th>
        <th>設定5</th>
        <th>設定6</th>
        <th>ストック有</th>
        <th>ストック無</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const tableBody = document.querySelector("#data-table tbody");

    const fixedData = [
      [1.98, 3.94, 5.86, 7.75, 9.61, 10.98],
      [7.75, 9.61, 27.77, 29.30, 30.43, 31.91],
      [6.62, 8.50, 23.84, 25.44, 26.69, 28.16],
      [5.48, 7.38, 19.70, 21.36, 22.75, 24.21],
      [4.33, 6.25, 15.33, 17.06, 18.60, 20.03],
      [3.16, 5.10, 10.72, 12.53, 14.22, 15.63],
      [40.18, 41.50, 53.35, 60.23, 61.14, 62.64],
      [33.34, 34.77, 47.96, 54.08, 55.05, 56.59],
      [25.71, 27.28, 41.95, 46.98, 48.01, 49.56],
      [17.22, 18.92, 35.25, 38.77, 39.86, 41.40],
      [32.53, 33.98, 45.13, 51.57, 52.63, 54.20], 
      [24.81, 26.39, 38.79, 44.08, 45.21, 46.79],
      [16.21, 17.93, 31.73, 35.43, 36.62, 38.17],
      [23.89, 25.49, 35.46, 41.02, 42.26, 43.85],
      [15.19, 16.93, 28.01, 31.90, 33.22, 34.77],
      [14.15, 15.91, 24.09, 28.17, 29.63, 31.17],
    ];
    
    const ptnData = [
      "✕✕✕✕✕",
      "○✕✕✕✕",
      "✕○✕✕✕",
      "✕✕○✕✕",
      "✕✕✕○✕",
      "✕✕✕✕○",
      "○○✕✕✕",
      "○✕○✕✕",
      "○✕✕○✕",
      "○✕✕✕○",
      "✕○○✕✕",
      "✕○✕○✕",
      "✕○✕✕○",
      "✕✕○○✕",
      "✕✕○✕○",
      "✕✕✕○○",
    ]
    
    const raffleData = [
      [0.4, 0.8, 1.2, 1.6, 2.0, 2.3],
      [1.6, 2.0, 6.3, 6.7, 7.0, 7.4],
      [11.7, 12.1, 16.0, 19.2, 19.6, 20.3]
    ]
    
    function getExpectValue(stg, zeroPnt, onePnt, twoPnt) {
      return (zeroPnt * raffleData[0][stg - 1]) + (onePnt * raffleData[1][stg - 1]) + (twoPnt * raffleData[2][stg - 1])
    }
    
    const expectedData = [
      [getExpectValue(1, 5, 0, 0), getExpectValue(2, 5, 0, 0), getExpectValue(3, 5, 0, 0), getExpectValue(4, 5, 0, 0), getExpectValue(5, 5, 0, 0), getExpectValue(6, 5, 0, 0)],
      [getExpectValue(1, 0, 5, 0), getExpectValue(2, 0, 5, 0), getExpectValue(3, 0, 5, 0), getExpectValue(4, 0, 5, 0), getExpectValue(5, 0, 5, 0), getExpectValue(6, 0, 5, 0)],
      [getExpectValue(1, 1, 4, 0), getExpectValue(2, 1, 4, 0), getExpectValue(3, 1, 4, 0), getExpectValue(4, 1, 4, 0), getExpectValue(5, 1, 4, 0), getExpectValue(6, 1, 4, 0)],
      [getExpectValue(1, 2, 3, 0), getExpectValue(2, 2, 3, 0), getExpectValue(3, 2, 3, 0), getExpectValue(4, 2, 3, 0), getExpectValue(5, 2, 3, 0), getExpectValue(6, 2, 3, 0)],
      [getExpectValue(1, 3, 2, 0), getExpectValue(2, 3, 2, 0), getExpectValue(3, 3, 2, 0), getExpectValue(4, 3, 2, 0), getExpectValue(5, 3, 2, 0), getExpectValue(6, 3, 2, 0)],
      [getExpectValue(1, 4, 1, 0), getExpectValue(2, 4, 1, 0), getExpectValue(3, 4, 1, 0), getExpectValue(4, 4, 1, 0), getExpectValue(5, 4, 1, 0), getExpectValue(6, 4, 1, 0)],
      [getExpectValue(1, 0, 1, 4), getExpectValue(2, 0, 1, 4), getExpectValue(3, 0, 1, 4), getExpectValue(4, 0, 1, 4), getExpectValue(5, 0, 1, 4), getExpectValue(6, 0, 1, 4)],
      [getExpectValue(1, 0, 2, 3), getExpectValue(2, 0, 2, 3), getExpectValue(3, 0, 2, 3), getExpectValue(4, 0, 2, 3), getExpectValue(5, 0, 2, 3), getExpectValue(6, 0, 2, 3)],
      [getExpectValue(1, 0, 3, 2), getExpectValue(2, 0, 3, 2), getExpectValue(3, 0, 3, 2), getExpectValue(4, 0, 3, 2), getExpectValue(5, 0, 3, 2), getExpectValue(6, 0, 3, 2)],
      [getExpectValue(1, 0, 4, 1), getExpectValue(2, 0, 4, 1), getExpectValue(3, 0, 4, 1), getExpectValue(4, 0, 4, 1), getExpectValue(5, 0, 4, 1), getExpectValue(6, 0, 4, 1)],
      [getExpectValue(1, 1, 1, 3), getExpectValue(2, 1, 1, 3), getExpectValue(3, 1, 1, 3), getExpectValue(4, 1, 1, 3), getExpectValue(5, 1, 1, 3), getExpectValue(6, 1, 1, 3)],
      [getExpectValue(1, 1, 2, 2), getExpectValue(2, 1, 2, 2), getExpectValue(3, 1, 2, 2), getExpectValue(4, 1, 2, 2), getExpectValue(5, 1, 2, 2), getExpectValue(6, 1, 2, 2)],
      [getExpectValue(1, 1, 3, 1), getExpectValue(2, 1, 3, 1), getExpectValue(3, 1, 3, 1), getExpectValue(4, 1, 3, 1), getExpectValue(5, 1, 3, 1), getExpectValue(6, 1, 3, 1)],
      [getExpectValue(1, 2, 1, 2), getExpectValue(2, 2, 1, 2), getExpectValue(3, 2, 1, 2), getExpectValue(4, 2, 1, 2), getExpectValue(5, 2, 1, 2), getExpectValue(6, 2, 1, 2)],
      [getExpectValue(1, 2, 2, 1), getExpectValue(2, 2, 2, 1), getExpectValue(3, 2, 2, 1), getExpectValue(4, 2, 2, 1), getExpectValue(5, 2, 2, 1), getExpectValue(6, 2, 2, 1)],
      [getExpectValue(1, 3, 1, 1), getExpectValue(2, 3, 1, 1), getExpectValue(3, 3, 1, 1), getExpectValue(4, 3, 1, 1), getExpectValue(5, 3, 1, 1), getExpectValue(6, 3, 1, 1)],
    ]

    function findClosestIndex(arr, target) {
      let closestIndex = 0;
      let minDiff = Math.abs(arr[0] - target);

      for (let i = 1; i < arr.length; i++) {
        let diff = Math.abs(arr[i] - target);
        if (diff < minDiff) {
          minDiff = diff;
          closestIndex = i;
        }
      }

      return closestIndex;
    }
    
    function loadCounterValue(rowId, type) {
      const val = localStorage.getItem(`counter-${rowId}-${type}`) || 0;
      return val;
    }

    function initRow(row) {
      const rowId = row.dataset.rowId;
      row.querySelector(".counter-a").value = loadCounterValue(row.dataset.rowId, "a");
      row.querySelector(".counter-b").value = loadCounterValue(row.dataset.rowId, "b");
      updateRow(row);
    }
    
    function calcExpectValue(isLowest = false) {
      var expectedArr = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
      
      document.querySelectorAll(".counter-a").forEach((v, i) => {
        for (let j = 0; j < 6; ++j) {
          if (isLowest) {
            expectedArr[j] += fixedData[i][j] * v.value;
          } else {
            expectedArr[j] += expectedData[i][j] * v.value;
          }
        }
      });
      
      document.querySelectorAll(".counter-b").forEach((v, i) => {
        for (let j = 0; j < 6; ++j) {
          if (isLowest) {
            expectedArr[j] += fixedData[i][j] * v.value;
          } else {
            expectedArr[j] += expectedData[i][j] * v.value;
          }
        }
      });
      
      return expectedArr;
    }
    
    function refreshExpectedValue(isLowest = false) {
      const row = isLowest ? document.getElementById("expected-prob-tr") : document.getElementById("expected-amt-tr");
      const values = row.dataset.values.split(",").map(Number);

      const exceptedArr = calcExpectValue(isLowest);

      values.forEach((v, i) => {
        const cell = row.querySelector(`.val-${i}`);
        cell.textContent = (exceptedArr[i] / 100).toFixed(1);
      });
      
      const td = document.getElementById("sum-success-rb");
      let num = 0;
      document.querySelectorAll(".counter-a").forEach((v, i) => {
        num += Number(v.value);
      });
      
      td.textContent = num;
      
      row.dataset.values = exceptedArr.join(",");
      
      if (isLowest) updateExpectedRow(row);
    }

    function updateRow(row) {
      const rowId = row.dataset.rowId;
      const values = row.dataset.values.split(",").map(Number);
      const a = Number(row.querySelector(".counter-a")?.value ?? 0);
      const b = Number(row.querySelector(".counter-b")?.value ?? 0);

      localStorage.setItem(`counter-${rowId}-a`, a);
      localStorage.setItem(`counter-${rowId}-b`, b);

      const c = (a / (a + b)) * 100;
      const tgt_i = findClosestIndex(values, c);

      values.forEach((v, i) => {
        const cell = row.querySelector(`.val-${i}`);
        cell.style.backgroundColor = "";
      });
      
      if (a === 0 && b === 0) return;
      
      const cell = row.querySelector(`.val-${tgt_i}`);
      cell.style.backgroundColor = "#e6f0e6";
    }

    function updateExpectedRow(row) {
      const values = row.dataset.values.split(",").map(Number);

      const num = Number(document.getElementById("sum-success-rb").textContent);
      console.log(num * 100);
      const tgt_i = findClosestIndex(values, num * 100);

      values.forEach((v, i) => {
        const cell = row.querySelector(`.val-${i}`);
        cell.style.backgroundColor = "";
      });
      
      if (num == 0) return;
      
      const cell = row.querySelector(`.val-${tgt_i}`);
      cell.style.backgroundColor = "#e6f0e6";
    }

    function resetAllCounters() {
      document.querySelectorAll(".counter-a, .counter-b").forEach(input => input.value = 0);
      document.querySelectorAll("tbody tr").forEach(row => updateRow(row));
      refreshExpectedValue(isLowest = true);
      refreshExpectedValue(isLowest = false);
    }

    function createExpectedStockAmtRow(tableBody) {
      const tr = document.createElement("tr");
      const values = calcExpectValue(isLowest = false);
      tr.dataset.values = values.join(",");
      const labelTd = document.createElement("td");
      labelTd.textContent = "平均ストック数";
      labelTd.className = "expected-amt-label";
      tr.appendChild(labelTd);
      values.forEach((val, idx) => {
        const td = document.createElement("td");
        td.textContent = (val / 100).toFixed(1);
        td.classList.add(`val-${idx}`);
        tr.appendChild(td);
      });
      tr.id = "expected-amt-tr";
      tableBody.appendChild(tr);
    }

    function createExpectedStockProbRow(tableBody) {
      const tr = document.createElement("tr");
      const values = calcExpectValue(isLowest = true);
      tr.dataset.values = values.join(",");
      const labelTd = document.createElement("td");
      labelTd.textContent = "平均初当たり回数";
      labelTd.className = "expected-prob-label";
      tr.appendChild(labelTd);
      values.forEach((val, idx) => {
        const td = document.createElement("td");
        td.textContent = (val / 100).toFixed(1);
        td.classList.add(`val-${idx}`);
        tr.appendChild(td);
      });
      const td = document.createElement("td");
      td.textContent = 0;
      td.id = "sum-success-rb"
      tr.appendChild(td);
      tr.id = "expected-prob-tr";
      tableBody.appendChild(tr);
    }

    function createCounterCell(className, row) {
      const td = document.createElement("td");
      const container = document.createElement("div");
      container.className = "counter-container";

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.classList.add(className);
      input.value = 0;
      input.oninput = () => {
        if (input.value < 0) input.value = 0;
        initRow(row);
      };

      const btnMinus = document.createElement("button");
      btnMinus.textContent = "−";
      btnMinus.onclick = () => {
        input.value = Math.max(0, parseInt(input.value) - 1);
        updateRow(row);
        refreshExpectedValue(isLowest = true);
        refreshExpectedValue(isLowest = false);
      };

      const btnPlus = document.createElement("button");
      btnPlus.textContent = "+";
      btnPlus.onclick = () => {
        input.value = parseInt(input.value) + 1;
        updateRow(row);
        refreshExpectedValue(isLowest = true);
        refreshExpectedValue(isLowest = false);
      };

      container.appendChild(btnMinus);
      container.appendChild(input);
      container.appendChild(btnPlus);

      td.appendChild(container);
      return td;
    }

    fixedData.forEach((values, rowIndex) => {
      const tr = document.createElement("tr");
      tr.dataset.rowId = `eureka-row${rowIndex}`;
      tr.dataset.values = values.join(",");

      const labelTd = document.createElement("td");
      labelTd.textContent = ptnData[rowIndex];
      labelTd.className = "row-label";
      tr.appendChild(labelTd);

      values.forEach((val, idx) => {
        const td = document.createElement("td");
        td.textContent = `${val.toFixed(2)}%`;
        td.classList.add(`val-${idx}`);
        tr.appendChild(td);
      });

      tr.appendChild(createCounterCell("counter-a", tr));
      tr.appendChild(createCounterCell("counter-b", tr));

      initRow(tr);

      tableBody.appendChild(tr);
    });
    
    createExpectedStockProbRow(tableBody);
    createExpectedStockAmtRow(tableBody);
    refreshExpectedValue(isLowest = true);
    refreshExpectedValue(isLowest = false);
  </script>
</body>
</html>
